<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Igreja - Gestão Financeira</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-title-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .church-logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #3498db;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            transition: transform 0.3s ease;
        }

        .church-logo:hover {
            transform: scale(1.1);
        }

        .logo-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            border: 3px solid #2980b9;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .logo-placeholder:hover {
            transform: scale(1.1);
        }

        .header-text {
            flex: 1;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .change-logo-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .change-logo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .logo-input {
            display: none;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            text-align: center;
        }

        .income-icon { color: #27ae60; }
        .expense-icon { color: #e74c3c; }
        .balance-icon { color: #3498db; }
        .pending-icon { color: #f39c12; }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        .card-value {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }

        .income-value { color: #27ae60; }
        .expense-value { color: #e74c3c; }
        .balance-value { color: #3498db; }
        .pending-value { color: #f39c12; }

        .charts-dashboard {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .chart-title {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3em;
            font-weight: 600;
        }

        .chart-legend {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 10px;
        }

        .legend-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .legend-label {
            font-weight: 500;
            color: #2c3e50;
        }

        .legend-value {
            font-weight: bold;
            color: #e74c3c;
        }

        .legend-percentage {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-left: 5px;
        }

        .expense-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .expense-summary-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .expense-summary-label {
            font-size: 0.8em;
            color: #7f8c8d;
            margin-bottom: 3px;
        }

        .expense-summary-value {
            font-size: 1em;
            font-weight: bold;
            color: #2c3e50;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 170px;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .transactions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .transaction-item.income {
            border-left-color: #27ae60;
        }

        .transaction-item.expense {
            border-left-color: #e74c3c;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .transaction-title {
            font-weight: 600;
            color: #2c3e50;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 1.1em;
        }

        .transaction-amount.income {
            color: #27ae60;
        }

        .transaction-amount.expense {
            color: #e74c3c;
        }

        .transaction-details {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .categories-section {
            grid-column: 1 / -1;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .category-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ecf0f1;
        }

        .category-group h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .category-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .reports-section {
            grid-column: 1 / -1;
        }

        /* Ajusta o grid para 4 colunas em telas grandes */
        .report-filters {
            display: grid;
            grid-template-columns: repeat(3, 180px) 1fr; /* 3 colunas fixas e 1 flexível */
            gap: 15px;
            align-items: flex-end; /* Alinha os itens pela base */
            margin-bottom: 20px;
        }

        /* Container específico para os botões de relatório */
        .btn-container-reports {
            display: flex;
            gap: 8px;
            margin-bottom: 0; /* Remove margem extra */
            padding-bottom: 2px; /* Ajuste fino de altura */
        }

        /* Garante que os botões não fiquem muito largos */
        .btn-container-reports .btn {
            padding: 10px 15px;
            font-size: 13px;
            white-space: nowrap;
        }

        /* Ajuste para dispositivos móveis */
        @media (max-width: 768px) {
            .report-filters {
                grid-template-columns: 1fr;
            }
            .btn-container-reports {
                flex-wrap: wrap;
                justify-content: center;
            }
}

        .report-results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .summary-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #e74c3c;
        }

        .toast.warning {
            background: #f39c12;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-title-container {
                flex-direction: column;
                text-align: center;
            }
            
            .church-logo, .logo-placeholder {
                margin: 0 auto;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content,
            .charts-dashboard {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .categories-grid {
                grid-template-columns: 1fr;
            }
            
            .report-filters {
                grid-template-columns: 1fr;
            }

            
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-title-container">
                <div class="logo-container">
                    <div class="logo-placeholder" id="logoPlaceholder" onclick="changeLogo()">
                        <i class="fas fa-church"></i>
                    </div>
                    <img id="churchLogo" class="church-logo" style="display: none;" alt="Logo da Igreja">
                </div>
                <div class="header-text">
                    <h1>Financeiro Igreja</h1>
                    <p>Sistema completo de gestão financeira para sua instituição religiosa</p>
                </div>
            </div>
            <button type="button" class="change-logo-btn" onclick="changeLogo()">
                <i class="fas fa-camera"></i> Mudar Logo
            </button>
            <input type="file" id="logoInput" class="logo-input" accept="image/*" onchange="handleLogoChange(event)">
        </div>

        <div class="dashboard">
            <div class="card">
                <div class="card-icon income-icon">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <h3>Total Receitas</h3>
                <div class="card-value income-value" id="totalIncome">R$ 0,00</div>
                <div style="text-align: center; color: #7f8c8d; font-size: 0.9em;">Este mês</div>
            </div>
            <div class="card">
                <div class="card-icon expense-icon">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <h3>Total Despesas</h3>
                <div class="card-value expense-value" id="totalExpenses">R$ 0,00</div>
                <div style="text-align: center; color: #7f8c8d; font-size: 0.9em;">Este mês</div>
            </div>
            <div class="card">
                <div class="card-icon balance-icon">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <h3>Saldo Atual</h3>
                <div class="card-value balance-value" id="currentBalance">R$ 0,00</div>
                <div style="text-align: center; color: #7f8c8d; font-size: 0.9em;">Disponível</div>
            </div>
            <div class="card">
                <div class="card-icon pending-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h3>Pendente</h3>
                <div class="card-value pending-value" id="pendingAmount">R$ 0,00</div>
                <div style="text-align: center; color: #7f8c8d; font-size: 0.9em;">A vencer</div>
            </div>
        </div>

        <div class="charts-dashboard">
            <div class="chart-section">
                <h2 class="chart-title">
                    <i class="fas fa-chart-pie expense-icon"></i>
                    Distribuição de Despesas por Categoria
                </h2>
                <div class="chart-container">
                    <canvas id="expensesPieChart"></canvas>
                </div>
                <div class="chart-legend" id="expensesLegend">
                    <!-- Legenda será preenchida dinamicamente -->
                </div>
            </div>
            
            <div class="chart-section">
                <h2 class="chart-title">
                    <i class="fas fa-chart-line balance-icon"></i>
                    Tendência de Receitas vs Despesas
                </h2>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="section">
                <h2><i class="fas fa-plus-circle"></i> Nova Transação</h2>
                <form id="transactionForm">
                    <div class="form-group">
                        <label for="transactionType">Tipo de Transação</label>
                        <select id="transactionType" required>
                            <option value="">Selecione o tipo</option>
                            <option value="income">Receita</option>
                            <option value="expense">Despesa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transactionCategory">Categoria</label>
                        <select id="transactionCategory" required>
                            <option value="">Selecione a categoria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transactionSubcategory">Subcategoria</label>
                        <select id="transactionSubcategory">
                            <option value="">Selecione a subcategoria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transactionAmount">Valor (R$)</label>
                        <input type="number" id="transactionAmount" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="transactionDescription">Descrição</label>
                        <input type="text" id="transactionDescription" required>
                    </div>
                    <div class="form-group">
                        <label for="transactionDate">Data</label>
                        <input type="date" id="transactionDate" required>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Registrar Transação
                    </button>
                </form>
            </div>

            <div class="section">
                <h2><i class="fas fa-list"></i> Últimas Transações</h2>
                <div class="transactions-list" id="transactionsList">
                    <!-- Transações serão adicionadas aqui dinamicamente -->
                </div>
            </div>
        </div>

        <div class="section categories-section">
            <h2><i class="fas fa-tags"></i> Gerenciar Categorias</h2>
            <div class="categories-grid">
                <div class="category-group">
                    <h4><i class="fas fa-arrow-up income-icon"></i> Categorias de Receitas</h4>
                    <div id="incomeCategories">
                        <!-- Categorias de receita serão adicionadas aqui -->
                    </div>
                    <button type="button" class="btn btn-success btn-small" onclick="openCategoryModal('income')">
                        <i class="fas fa-plus"></i> Adicionar Categoria
                    </button>
                </div>
                <div class="category-group">
                    <h4><i class="fas fa-arrow-down expense-icon"></i> Categorias de Despesas</h4>
                    <div id="expenseCategories">
                        <!-- Categorias de despesa serão adicionadas aqui -->
                    </div>
                    <button type="button" class="btn btn-danger btn-small" onclick="openCategoryModal('expense')">
                        <i class="fas fa-plus"></i> Adicionar Categoria
                    </button>
                </div>
            </div>
        </div>

        <div class="section reports-section">
            <h2><i class="fas fa-chart-bar"></i> Relatórios Financeiros</h2>
            <div class="report-filters">
                <div class="form-group">
                    <label for="reportType">Tipo de Relatório</label>
                    <select id="reportType">
                        <option value="summary">Resumo Financeiro</option>
                        <option value="detailed">Detalhado por Categoria</option>
                        <option value="cashflow">Fluxo de Caixa</option>
                        <option value="comparison">Comparativo Mensal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportStartDate">Data Inicial</label>
                    <input type="date" id="reportStartDate">
                </div>
                <div class="form-group">
                    <label for="reportEndDate">Data Final</label>
                    <input type="date" id="reportEndDate">
                </div>
                <div class="form-group btn-container-reports">
                    <button type="button" class="btn btn-primary" onclick="generateReport()" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                        <i class="fas fa-chart-line"></i> Relatório
                    </button>
                    <button type="button" class="btn" onclick="exportToPDF()" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button type="button" class="btn" onclick="exportToExcel()" style="background: linear-gradient(135deg, #27ae60, #229954);">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                </div>
            </div>
            <div class="report-results" id="reportResults" style="display: none;">
                <h4>Resultados do Relatório</h4>
                <div class="summary-grid" id="reportSummary">
                    <!-- Resumo do relatório será adicionado aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar/editar categorias -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="categoryModalTitle">Adicionar Categoria</h3>
                <span class="close" onclick="closeCategoryModal()">&times;</span>
            </div>
            <form id="categoryForm">
                <div class="form-group">
                    <label for="categoryName">Nome da Categoria</label>
                    <input type="text" id="categoryName" required>
                </div>
                <div class="form-group">
                    <label for="categoryType">Tipo</label>
                    <select id="categoryType" required>
                        <option value="income">Receita</option>
                        <option value="expense">Despesa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="categorySubcategories">Subcategorias (separadas por vírgula)</label>
                    <textarea id="categorySubcategories" rows="3" placeholder="Ex: Dízimo, Oferta, Missões"></textarea>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Salvar Categoria
                </button>
            </form>
        </div>
    </div>

    <!-- Modal para editar transação -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Transação</h3>
                <span class="close" onclick="closeEditTransactionModal()">&times;</span>
            </div>
            <form id="editTransactionForm">
                <input type="hidden" id="editTransactionId">
                <div class="form-group">
                    <label for="editTransactionType">Tipo de Transação</label>
                    <select id="editTransactionType" required>
                        <option value="income">Receita</option>
                        <option value="expense">Despesa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editTransactionCategory">Categoria</label>
                    <select id="editTransactionCategory" required>
                        <option value="">Selecione a categoria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editTransactionSubcategory">Subcategoria</label>
                    <select id="editTransactionSubcategory">
                        <option value="">Selecione a subcategoria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editTransactionAmount">Valor (R$)</label>
                    <input type="number" id="editTransactionAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="editTransactionDescription">Descrição</label>
                    <input type="text" id="editTransactionDescription" required>
                </div>
                <div class="form-group">
                    <label for="editTransactionDate">Data</label>
                    <input type="date" id="editTransactionDate" required>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Atualizar Transação
                </button>
            </form>
        </div>
    </div>

    <script>
        // 1. CONFIGURAÇÃO DO SEU FIREBASE (Substitua pelos seus dados do console)
        const firebaseConfig = {
            apiKey: "AIzaSyAUhgnaZuaEaf_f9qfptB4A5TN3BsGgJ-w",
            authDomain: "financeiroigreja-2f7a8.firebaseapp.com",
            projectId: "financeiroigreja-2f7a8",
            storageBucket: "financeiroigreja-2f7a8.firebasestorage.app",
            messagingSenderId: "293872748599",
            appId: "1:293872748599:web:59cabbc6654aa65364d7b2",
            measurementId: "G-HZHWPP0T3M"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // CORREÇÃO: Declarar churchSystem como variável global primeiro
        let churchSystem;

        // Sistema de Gestão Financeira para Igrejas
        class ChurchFinancialSystem {
            constructor() {
                this.transactions = [];
                this.categories = [];
                this.setupRealtimeSync();
            }

            // SINCRONIZAÇÃO EM TEMPO REAL (Transações, Categorias e Logo)
            setupRealtimeSync() {
                // Sincronizar Transações
                db.collection("transacoes").orderBy("date", "desc").onSnapshot((snapshot) => {
                    this.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.updateUI();
                });

                // Sincronizar Categorias
                db.collection("configuracoes").doc("categorias").onSnapshot((doc) => {
                    if (doc.exists) {
                        this.categories = doc.data().lista;
                    } else {
                        // Se não existir no banco, cria as padrões
                        this.categories = ['Dízimo', 'Oferta', 'Doação', 'Aluguel', 'Energia', 'Água', 'Manutenção'];
                        this.saveCategoriesCloud();
                    }
                    this.renderCategories();
                });

                // Sincronizar Logo
                db.collection("configuracoes").doc("logo").onSnapshot((doc) => {
                    if (doc.exists) {
                        const logoData = doc.data().base64;
                        const placeholder = document.getElementById('logoPlaceholder');
                        placeholder.innerHTML = `<img src="${logoData}" class="church-logo">`;
                    }
                });
            }

            // 3. SALVAR NO FIREBASE
            async addTransaction(transaction) {
                await db.collection("transacoes").add(transaction);
            }

            async deleteTransaction(id) {
                await db.collection("transacoes").doc(id).delete();
            }

            async saveCategoriesCloud() {
                await db.collection("configuracoes").doc("categorias").set({ lista: this.categories });
            }

            async updateLogoCloud(base64Data) {
                await db.collection("configuracoes").doc("logo").set({ base64: base64Data });
            }

            // 4. DELETAR DO FIREBASE
            async deleteTransaction(id) {
                try {
                    await db.collection("transacoes").doc(id).delete();
                } catch (error) {
                    console.error("Erro ao deletar:", error);
                }
            }

            updateUI() {
                this.updateBalance();
                this.renderTransactions();
                this.updateCharts();
            }

            init() {
                this.setupEventListeners();
                this.updateDashboard();
                this.renderCategories();
                this.renderTransactions();
                this.setupFormHandlers();
                this.setDefaultDates();
                this.updateCharts();
                this.loadSavedLogo();
            }

            getDefaultCategories() {
                return {
                    income: [
                        {
                            id: 'cat-income-1',
                            name: 'Dízimos',
                            subcategories: ['Dízimo Mensal', 'Dízimo Semanal', 'Dízimo Online']
                        },
                        {
                            id: 'cat-income-2',
                            name: 'Ofertas',
                            subcategories: ['Oferta Geral', 'Oferta Especial', 'Oferta de Missões']
                        },
                        {
                            id: 'cat-income-3',
                            name: 'Doações',
                            subcategories: ['Doação de Membros', 'Doação de Visitantes', 'Doação Especial']
                        },
                        {
                            id: 'cat-income-4',
                            name: 'Eventos',
                            subcategories: ['Cultos Especiais', 'Conferências', 'Workshops']
                        },
                        {
                            id: 'cat-income-5',
                            name: 'Aluguéis',
                            subcategories: ['Aluguel de Salas', 'Aluguel de Equipamentos']
                        }
                    ],
                    expense: [
                        {
                            id: 'cat-expense-1',
                            name: 'Salários',
                            subcategories: ['Pastor', 'Secretário', 'Limpeza', 'Música']
                        },
                        {
                            id: 'cat-expense-2',
                            name: 'Manutenção',
                            subcategories: ['Predial', 'Equipamentos', 'Jardim']
                        },
                        {
                            id: 'cat-expense-3',
                            name: 'Serviços Públicos',
                            subcategories: ['Água', 'Luz', 'Gás', 'Internet', 'Telefone']
                        },
                        {
                            id: 'cat-expense-4',
                            name: 'Materiais',
                            subcategories: ['Estantes Bíblicas', 'Material de Escola Dominical', 'Material de Escritório']
                        },
                        {
                            id: 'cat-expense-5',
                            name: 'Missões',
                            subcategories: ['Missões Locais', 'Missões Nacionais', 'Missões Internacionais']
                        }
                    ]
                };
            }

            setupEventListeners() {
                // Garantir que os event listeners sejam adicionados após o DOM carregar
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.setupEventListeners());
                    return;
                }

                // Formulário de transação
                const transactionType = document.getElementById('transactionType');
                const transactionCategory = document.getElementById('transactionCategory');
                const editTransactionType = document.getElementById('editTransactionType');
                const editTransactionCategory = document.getElementById('editTransactionCategory');

                if (transactionType) {
                    transactionType.addEventListener('change', (e) => {
                        this.updateCategoryOptions(e.target.value);
                    });
                }

                if (transactionCategory) {
                    transactionCategory.addEventListener('change', (e) => {
                        this.updateSubcategoryOptions(e.target.value);
                    });
                }

                // Formulário de edição
                if (editTransactionType) {
                    editTransactionType.addEventListener('change', (e) => {
                        this.updateEditCategoryOptions(e.target.value);
                    });
                }

                if (editTransactionCategory) {
                    editTransactionCategory.addEventListener('change', (e) => {
                        this.updateEditSubcategoryOptions(e.target.value);
                    });
                }

                // Filtros de relatório
                const reportType = document.getElementById('reportType');
                const reportStartDate = document.getElementById('reportStartDate');
                const reportEndDate = document.getElementById('reportEndDate');

                if (reportType) {
                    reportType.addEventListener('change', () => {
                        this.generateReport();
                    });
                }

                if (reportStartDate) {
                    reportStartDate.addEventListener('change', () => {
                        this.generateReport();
                    });
                }

                if (reportEndDate) {
                    reportEndDate.addEventListener('change', () => {
                        this.generateReport();
                    });
                }
            }

            setupFormHandlers() {
                // Formulário de transação
                const form = document.getElementById('transactionForm');
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const newTransaction = {
                        description: document.getElementById('description').value,
                        amount: parseFloat(document.getElementById('amount').value),
                        type: document.getElementById('type').value,
                        category: document.getElementById('category').value,
                        date: document.getElementById('date').value,
                        createdAt: new Date().toISOString()
                    };
                    
                    await this.addTransaction(newTransaction);
                    form.reset();
                }

                // Formulário de categoria
                const categoryForm = document.getElementById('categoryForm');
                if (categoryForm) {
                    categoryForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveCategory();
                    });
                }

              

                // Formulário de edição
                const editTransactionForm = document.getElementById('editTransactionForm');
                if (editTransactionForm) {
                    editTransactionForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.updateTransaction();
                    });
                }
            }

            saveCategory() {
                // Verificar se está em modo de edição
                if (this.currentEditingCategory) {
                    this.saveEditedCategory();
                    return;
                }
                
                // Código original para adicionar nova categoria
                const categoryName = document.getElementById('categoryName');
                const categoryType = document.getElementById('categoryType');
                const categorySubcategories = document.getElementById('categorySubcategories');
                
                if (!categoryName || !categoryType) return;

                const name = categoryName.value.trim();
                const type = categoryType.value;
                const subcategoriesText = categorySubcategories ? categorySubcategories.value.trim() : '';
                
                if (!name || !type) return;

                const subcategories = subcategoriesText ? 
                    subcategoriesText.split(',').map(s => s.trim()).filter(s => s) : [];


                if (this.currentEditingCategory && this.currentEditingCategory.id) {
                    // MODO EDIÇÃO
                    this.saveEditedCategory();
                    return;
                }

                const newCategory = {
                    id: `cat-${type}-${Date.now()}`,
                    name: name,
                    subcategories: subcategories
                };

                if (!this.categories[type]) {
                    this.categories[type] = [];
                }

                this.categories[type].push(newCategory);
                this.saveData();
                this.renderCategories();
                this.closeCategoryModal();
                this.showToast('Categoria salva com sucesso!', 'success');
            }

            setDefaultDates() {
                const today = new Date().toISOString().split('T')[0];
                const transactionDate = document.getElementById('transactionDate');
                const editTransactionDate = document.getElementById('editTransactionDate');
                
                if (transactionDate) transactionDate.value = today;
                if (editTransactionDate) editTransactionDate.value = today;
                
                const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
                const lastDay = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).toISOString().split('T')[0];
                
                const reportStartDate = document.getElementById('reportStartDate');
                const reportEndDate = document.getElementById('reportEndDate');
                
                if (reportStartDate) reportStartDate.value = firstDay;
                if (reportEndDate) reportEndDate.value = lastDay;
            }

            updateCategoryOptions(type) {
                const categorySelect = document.getElementById('transactionCategory');
                if (!categorySelect) return;
                
                categorySelect.innerHTML = '<option value="">Selecione a categoria</option>';
                
                if (type && this.categories[type]) {
                    this.categories[type].forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                }
            }

            updateSubcategoryOptions(categoryId) {
                const subcategorySelect = document.getElementById('transactionSubcategory');
                if (!subcategorySelect) return;
                
                subcategorySelect.innerHTML = '<option value="">Selecione a subcategoria</option>';
                
                if (categoryId) {
                    const type = document.getElementById('transactionType').value;
                    const category = this.categories[type]?.find(cat => cat.id === categoryId);
                    
                    if (category && category.subcategories) {
                        category.subcategories.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory;
                            option.textContent = subcategory;
                            subcategorySelect.appendChild(option);
                        });
                    }
                }
            }

            updateEditCategoryOptions(type) {
                const categorySelect = document.getElementById('editTransactionCategory');
                if (!categorySelect) return;
                
                categorySelect.innerHTML = '<option value="">Selecione a categoria</option>';
                
                if (type && this.categories[type]) {
                    this.categories[type].forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                }
            }

            updateEditSubcategoryOptions(categoryId) {
                const subcategorySelect = document.getElementById('editTransactionSubcategory');
                if (!subcategorySelect) return;
                
                subcategorySelect.innerHTML = '<option value="">Selecione a subcategoria</option>';
                
                if (categoryId) {
                    const type = document.getElementById('editTransactionType').value;
                    const category = this.categories[type]?.find(cat => cat.id === categoryId);
                    
                    if (category && category.subcategories) {
                        category.subcategories.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory;
                            option.textContent = subcategory;
                            subcategorySelect.appendChild(option);
                        });
                    }
                }
            }

            addTransaction() {
                const transactionType = document.getElementById('transactionType');
                const transactionCategory = document.getElementById('transactionCategory');
                const transactionSubcategory = document.getElementById('transactionSubcategory');
                const transactionAmount = document.getElementById('transactionAmount');
                const transactionDescription = document.getElementById('transactionDescription');
                const transactionDate = document.getElementById('transactionDate');

                if (!transactionType || !transactionCategory || !transactionAmount || !transactionDescription || !transactionDate) {
                    this.showToast('Por favor, preencha todos os campos obrigatórios!', 'error');
                    return;
                }

                const transaction = {
                    id: Date.now().toString(),
                    type: transactionType.value,
                    categoryId: transactionCategory.value,
                    subcategory: transactionSubcategory.value,
                    amount: parseFloat(transactionAmount.value),
                    description: transactionDescription.value,
                    date: transactionDate.value,
                    createdAt: new Date().toISOString()
                };

                this.transactions.push(transaction);
                this.saveData();
                this.updateDashboard();
                this.renderTransactions();
                this.updateCharts();
                
                // Limpar formulário
                if (transactionType) transactionType.value = '';
                if (transactionCategory) transactionCategory.value = '';
                if (transactionSubcategory) transactionSubcategory.value = '';
                if (transactionAmount) transactionAmount.value = '';
                if (transactionDescription) transactionDescription.value = '';
                
                this.setDefaultDates();
                this.showToast('Transação registrada com sucesso!', 'success');
            }

            editTransaction(id) {
                const transaction = this.transactions.find(t => t.id === id);
                if (!transaction) return;

                this.currentEditingTransaction = transaction;
                
                const editTransactionId = document.getElementById('editTransactionId');
                const editTransactionType = document.getElementById('editTransactionType');
                const editTransactionCategory = document.getElementById('editTransactionCategory');
                const editTransactionSubcategory = document.getElementById('editTransactionSubcategory');
                const editTransactionAmount = document.getElementById('editTransactionAmount');
                const editTransactionDescription = document.getElementById('editTransactionDescription');
                const editTransactionDate = document.getElementById('editTransactionDate');

                if (editTransactionId) editTransactionId.value = transaction.id;
                if (editTransactionType) editTransactionType.value = transaction.type;
                this.updateEditCategoryOptions(transaction.type);
                if (editTransactionCategory) editTransactionCategory.value = transaction.categoryId;
                this.updateEditSubcategoryOptions(transaction.categoryId);
                if (editTransactionSubcategory) editTransactionSubcategory.value = transaction.subcategory;
                if (editTransactionAmount) editTransactionAmount.value = transaction.amount;
                if (editTransactionDescription) editTransactionDescription.value = transaction.description;
                if (editTransactionDate) editTransactionDate.value = transaction.date;

                const editModal = document.getElementById('editTransactionModal');
                if (editModal) editModal.style.display = 'block';
            }

            updateTransaction() {
                const editTransactionId = document.getElementById('editTransactionId');
                const editTransactionType = document.getElementById('editTransactionType');
                const editTransactionCategory = document.getElementById('editTransactionCategory');
                const editTransactionSubcategory = document.getElementById('editTransactionSubcategory');
                const editTransactionAmount = document.getElementById('editTransactionAmount');
                const editTransactionDescription = document.getElementById('editTransactionDescription');
                const editTransactionDate = document.getElementById('editTransactionDate');

                if (!editTransactionId || !editTransactionType || !editTransactionCategory || !editTransactionAmount || !editTransactionDescription || !editTransactionDate) {
                    this.showToast('Por favor, preencha todos os campos obrigatórios!', 'error');
                    return;
                }

                const id = editTransactionId.value;
                const transactionIndex = this.transactions.findIndex(t => t.id === id);
                
                if (transactionIndex === -1) return;

                this.transactions[transactionIndex] = {
                    ...this.transactions[transactionIndex],
                    type: editTransactionType.value,
                    categoryId: editTransactionCategory.value,
                    subcategory: editTransactionSubcategory.value,
                    amount: parseFloat(editTransactionAmount.value),
                    description: editTransactionDescription.value,
                    date: editTransactionDate.value
                };

                this.saveData();
                this.updateDashboard();
                this.renderTransactions();
                this.updateCharts();
                this.closeEditTransactionModal();
                this.showToast('Transação atualizada com sucesso!', 'success');
            }

            deleteTransaction(id) {
                if (confirm('Tem certeza que deseja excluir esta transação?')) {
                    this.transactions = this.transactions.filter(t => t.id !== id);
                    this.saveData();
                    this.updateDashboard();
                    this.renderTransactions();
                    this.updateCharts();
                    this.showToast('Transação excluída com sucesso!', 'warning');
                }
            }

            saveEditedCategory() {
                if (!this.currentEditingCategory || !this.currentEditingCategory.id) {
                    this.showToast('Erro: modo de edição não inicializado', 'error');
                    return;
                }

                const categoryName = document.getElementById('categoryName');
                const categoryType = document.getElementById('categoryType');
                const categorySubcategories = document.getElementById('categorySubcategories');

                if (!categoryName || !categoryType || !categorySubcategories) return;

                const newName = categoryName.value.trim();
                const newType = categoryType.value;
                const subcategoriesText = categorySubcategories.value.trim();
                
                if (!newName) {
                    this.showToast('Nome da categoria é obrigatório', 'error');
                    return;
                }

                const subcategories = subcategoriesText ? 
                    subcategoriesText.split(',').map(s => s.trim()).filter(s => s) : [];

                // Encontrar a categoria original
                const originalType = this.currentEditingCategory.originalType;
                const categoryIndex = this.categories[originalType].findIndex(
                    cat => cat.id === this.currentEditingCategory.id
                );
                
                if (categoryIndex === -1) {
                    this.showToast('Categoria original não encontrada', 'error');
                    return;
                }

                // Se mudou o tipo, verificar se há transações
                if (newType !== originalType) {
                    const hasTransactions = this.transactions.some(t => t.categoryId === this.currentEditingCategory.id);
                    if (hasTransactions) {
                        this.showToast('Não é possível mudar o tipo: há transações usando esta categoria', 'error');
                        return;
                    }
                }

                // Atualizar a categoria
                const updatedCategory = {
                    id: this.currentEditingCategory.id,
                    name: newName,
                    subcategories: subcategories
                };

                // Se mudou o tipo, mover para o novo array
                if (newType !== originalType) {
                    // Remover da posição antiga
                    this.categories[originalType].splice(categoryIndex, 1);
                    
                    // Adicionar na nova posição
                    if (!this.categories[newType]) {
                        this.categories[newType] = [];
                    }
                    this.categories[newType].push(updatedCategory);
                } else {
                    // Mesmo tipo, apenas atualizar
                    this.categories[originalType][categoryIndex] = updatedCategory;
                }

                // Limpar estado de edição
                this.currentEditingCategory = null;
                
                // Atualizar interface
                this.saveData();
                this.renderCategories();
                this.closeCategoryModal();
                this.showToast('Categoria atualizada com sucesso!', 'success');
            }

            // Adicione esta função dentro da classe ChurchFinancialSystem
            editCategory(type, categoryId) {
                const category = this.categories[type]?.find(cat => cat.id === categoryId);
                if (!category) return;

                // Preencher o formulário de edição
                const categoryModal = document.getElementById('categoryModal');
                const categoryName = document.getElementById('categoryName');
                const categoryType = document.getElementById('categoryType');
                const categorySubcategories = document.getElementById('categorySubcategories');
                const categoryModalTitle = document.getElementById('categoryModalTitle');

                if (categoryModal && categoryName && categoryType && categorySubcategories && categoryModalTitle) {
                    categoryName.value = category.name;
                    categoryType.value = type;
                    categorySubcategories.value = category.subcategories ? category.subcategories.join(', ') : '';
                    categoryModalTitle.textContent = 'Editar Categoria';
                    
                    // Armazenar informações de edição
                    this.currentEditingCategory = { type: type, id: categoryId };
                    
                    categoryModal.style.display = 'block';
                }
            }

            // E também adicione a função para salvar a edição da categoria
            saveEditedCategory() {
                if (!this.currentEditingCategory) return;

                const categoryName = document.getElementById('categoryName');
                const categoryType = document.getElementById('categoryType');
                const categorySubcategories = document.getElementById('categorySubcategories');

                if (!categoryName || !categoryType || !categorySubcategories) return;

                const newName = categoryName.value.trim();
                const newType = categoryType.value;
                const subcategoriesText = categorySubcategories.value.trim();
                
                if (!newName) {
                    this.showToast('Nome da categoria é obrigatório', 'error');
                    return;
                }

                // Verificar se mudou o tipo e se há transações
                if (newType !== this.currentEditingCategory.type) {
                    const hasTransactions = this.transactions.some(t => t.categoryId === this.currentEditingCategory.id);
                    if (hasTransactions) {
                        this.showToast('Não é possível mudar o tipo: há transações usando esta categoria', 'error');
                        return;
                    }
                }

                const subcategories = subcategoriesText ? 
                    subcategoriesText.split(',').map(s => s.trim()).filter(s => s) : [];

                // Remover categoria antiga da posição original
                const oldCategoryIndex = this.categories[this.currentEditingCategory.type].findIndex(
                    cat => cat.id === this.currentEditingCategory.id
                );
                
                if (oldCategoryIndex !== -1) {
                    this.categories[this.currentEditingCategory.type].splice(oldCategoryIndex, 1);
                }

                // Adicionar na nova posição se mudou o tipo
                if (newType !== this.currentEditingCategory.type) {
                    if (!this.categories[newType]) {
                        this.categories[newType] = [];
                    }
                    this.categories[newType].push({
                        id: this.currentEditingCategory.id,
                        name: newName,
                        subcategories: subcategories
                    });
                } else {
                    // Mesmo tipo, apenas atualizar
                    this.categories[newType][oldCategoryIndex] = {
                        id: this.currentEditingCategory.id,
                        name: newName,
                        subcategories: subcategories
                    };
                }

                this.currentEditingCategory = null;
                this.saveData();
                this.renderCategories();
                this.closeCategoryModal();
                this.showToast('Categoria atualizada com sucesso!', 'success');
            }

            
                

            updateDashboard() {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                const monthlyTransactions = this.transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getMonth() === currentMonth && 
                           transactionDate.getFullYear() === currentYear;
                });

                const totalIncome = monthlyTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);

                const totalExpenses = monthlyTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                const currentBalance = this.transactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0) -
                    this.transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                const pendingAmount = this.transactions
                    .filter(t => new Date(t.date) > new Date())
                    .reduce((sum, t) => sum + t.amount, 0);

                const totalIncomeElement = document.getElementById('totalIncome');
                const totalExpensesElement = document.getElementById('totalExpenses');
                const currentBalanceElement = document.getElementById('currentBalance');
                const pendingAmountElement = document.getElementById('pendingAmount');

                if (totalIncomeElement) totalIncomeElement.textContent = this.formatCurrency(totalIncome);
                if (totalExpensesElement) totalExpensesElement.textContent = this.formatCurrency(totalExpenses);
                if (currentBalanceElement) currentBalanceElement.textContent = this.formatCurrency(currentBalance);
                if (pendingAmountElement) pendingAmountElement.textContent = this.formatCurrency(pendingAmount);
            }

            updateCharts() {
                this.updateExpensesPieChart();
                this.updateTrendChart();
            }

            updateExpensesPieChart() {
                const expenseTransactions = this.transactions.filter(t => t.type === 'expense');
                const categoryTotals = {};

                expenseTransactions.forEach(transaction => {
                    const category = this.getCategoryById(transaction.categoryId);
                    if (category) {
                        if (!categoryTotals[category.name]) {
                            categoryTotals[category.name] = 0;
                        }
                        categoryTotals[category.name] += transaction.amount;
                    }
                });

                const labels = Object.keys(categoryTotals);
                const data = Object.values(categoryTotals);
                const total = data.reduce((sum, value) => sum + value, 0);

                // CORREÇÃO: Usar função separada para formatar moeda
                const formatCurrency = this.formatCurrency.bind(this);

                const colors = [
                    '#e74c3c', '#c0392b', '#a93226', '#922b21', '#7b241c',
                    '#f39c12', '#d68910', '#b7950b', '#9c640c', '#7e5109',
                    '#8e44ad', '#7d3c98', '#6c3483', '#5b2c6f', '#4a235a',
                    '#3498db', '#2980b9', '#21618c', '#1b4f7a', '#154360'
                ];

                const chartData = {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 10
                    }]
                };

                const config = {
                    type: 'pie',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                color: '#ffffff',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: (value, context) => {
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${percentage}%`;
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true
                        }
                    },
                    plugins: [ChartDataLabels]
                };

                // Destruir gráfico anterior se existir
                if (this.expensesPieChart) {
                    this.expensesPieChart.destroy();
                }

                // Criar novo gráfico
                const ctx = document.getElementById('expensesPieChart');
                if (ctx) {
                    this.expensesPieChart = new Chart(ctx, config);
                    this.updateExpensesLegend(labels, data, total, colors);
                }
            }

            updateExpensesLegend(labels, data, total, colors) {
                const legendContainer = document.getElementById('expensesLegend');
                if (!legendContainer) return;
                
                let legendHTML = '<h4 style="margin-bottom: 15px; color: #2c3e50;">Detalhamento por Categoria:</h4>';
                
                labels.forEach((label, index) => {
                    const value = data[index];
                    const percentage = ((value / total) * 100).toFixed(1);
                    const color = colors[index];
                    
                    legendHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: ${color};"></div>
                            <div class="legend-info">
                                <span class="legend-label">${label}</span>
                                <span>
                                    <span class="legend-value">${this.formatCurrency(value)}</span>
                                    <span class="legend-percentage">(${percentage}%)</span>
                                </span>
                            </div>
                        </div>
                    `;
                });

                legendHTML += `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #ecf0f1;">
                        <div class="expense-summary">
                            <div class="expense-summary-item">
                                <div class="expense-summary-label">Total de Despesas</div>
                                <div class="expense-summary-value" style="color: #e74c3c;">${this.formatCurrency(total)}</div>
                            </div>
                            <div class="expense-summary-item">
                                <div class="expense-summary-label">Categorias</div>
                                <div class="expense-summary-value">${labels.length}</div>
                            </div>
                            <div class="expense-summary-item">
                                <div class="expense-summary-label">Média por Categoria</div>
                                <div class="expense-summary-value">${this.formatCurrency(total / labels.length)}</div>
                            </div>
                        </div>
                    </div>
                `;

                legendContainer.innerHTML = legendHTML;
            }

            updateTrendChart() {
                const monthlyData = this.getMonthlyTrendData();
                
                // CORREÇÃO: Usar função separada para formatar moeda
                const formatCurrency = this.formatCurrency.bind(this);

                const chartData = {
                    labels: monthlyData.labels,
                    datasets: [
                        {
                            label: 'Receitas',
                            data: monthlyData.income,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Despesas',
                            data: monthlyData.expenses,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                };

                const config = {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Mês'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Valor (R$)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        }
                    }
                };

                // Destruir gráfico anterior se existir
                if (this.trendChart) {
                    this.trendChart.destroy();
                }

                // Criar novo gráfico
                const ctx = document.getElementById('trendChart');
                if (ctx) {
                    this.trendChart = new Chart(ctx, config);
                }
            }

            getMonthlyTrendData() {
                const months = [];
                const incomeData = [];
                const expenseData = [];
                
                for (let i = 5; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    
                    const month = date.getMonth();
                    const year = date.getFullYear();
                    const monthName = date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    
                    months.push(monthName);
                    
                    const monthlyTransactions = this.transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        return transactionDate.getMonth() === month && transactionDate.getFullYear() === year;
                    });
                    
                    const monthIncome = monthlyTransactions
                        .filter(t => t.type === 'income')
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const monthExpenses = monthlyTransactions
                        .filter(t => t.type === 'expense')
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    incomeData.push(monthIncome);
                    expenseData.push(monthExpenses);
                }
                
                return {
                    labels: months,
                    income: incomeData,
                    expenses: expenseData
                };
            }

            renderTransactions() {
                const container = document.getElementById('transactionsList');
                if (!container) return;

                const recentTransactions = this.transactions
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 10);

                if (recentTransactions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Nenhuma transação registrada ainda.</p>';
                    return;
                }

                container.innerHTML = recentTransactions.map(transaction => {
                    const category = this.getCategoryById(transaction.categoryId);
                    const categoryName = category ? category.name : 'Categoria não encontrada';
                    
                    return `
                        <div class="transaction-item ${transaction.type}">
                            <div class="transaction-header">
                                <div class="transaction-title">${transaction.description}</div>
                                <div class="transaction-amount ${transaction.type}">
                                    ${transaction.type === 'income' ? '+' : '-'} ${this.formatCurrency(transaction.amount)}
                                </div>
                            </div>
                            <div class="transaction-details">
                                <i class="fas fa-tag"></i> ${categoryName} 
                                ${transaction.subcategory ? `> ${transaction.subcategory}` : ''}
                                <br>
                                <i class="fas fa-calendar"></i> ${this.formatDate(transaction.date)}
                            </div>
                            <div class="transaction-actions" style="margin-top: 10px; text-align: right;">
                                <button type="button" class="btn btn-warning btn-small" onclick="churchSystem.editTransaction('${transaction.id}')">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button type="button" class="btn btn-danger btn-small" onclick="churchSystem.deleteTransaction('${transaction.id}')">
                                    <i class="fas fa-trash"></i> Excluir
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderCategories() {
                this.renderCategoryGroup('income');
                this.renderCategoryGroup('expense');
            }

            renderCategoryGroup(type) {
                const container = document.getElementById(`${type}Categories`);
                if (!container) return;
                
                const categories = this.categories[type] || [];
                
                if (categories.length === 0) {
                    container.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">Nenhuma categoria cadastrada.</p>';
                    return;
                }

                container.innerHTML = categories.map(category => `
                    <div class="category-item">
                        <div>
                            <strong>${category.name}</strong>
                            ${category.subcategories && category.subcategories.length > 0 ? 
                                `<br><small style="color: #7f8c8d;">${category.subcategories.join(', ')}</small>` : ''}
                        </div>
                        <div class="category-actions">
                            <button type="button" class="btn btn-warning btn-small" onclick="churchSystem.editCategory('${type}', '${category.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-danger btn-small" onclick="churchSystem.deleteCategory('${type}', '${category.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            getCategoryById(categoryId) {
                for (const type in this.categories) {
                    const category = this.categories[type].find(cat => cat.id === categoryId);
                    if (category) return category;
                }
                return null;
            }

            generateReport() {
                const reportType = document.getElementById('reportType');
                const reportStartDate = document.getElementById('reportStartDate');
                const reportEndDate = document.getElementById('reportEndDate');
                
                if (!reportType) return;

                let filteredTransactions = this.transactions;
                
                if (reportStartDate && reportEndDate && reportStartDate.value && reportEndDate.value) {
                    const startDate = new Date(reportStartDate.value);
                    const endDate = new Date(reportEndDate.value);
                    
                    // Adicionar 1 dia à data final para incluir todo o dia 10/12/2025
                    endDate.setDate(endDate.getDate() + 1);
                    
                    filteredTransactions = this.transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        return transactionDate >= startDate && transactionDate <= endDate; // Usar < ao invés de <=
                    });
                }

                const reportResults = document.getElementById('reportResults');
                const reportSummary = document.getElementById('reportSummary');
                
                if (!reportResults || !reportSummary) return;

                if (filteredTransactions.length === 0) {
                    reportResults.style.display = 'block';
                    reportSummary.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Nenhuma transação encontrada no período selecionado.</p>';
                    return;
                }

                let summaryHTML = '';
                
                switch (reportType.value) {
                    case 'summary':
                        summaryHTML = this.generateSummaryReport(filteredTransactions);
                        break;
                    case 'detailed':
                        summaryHTML = this.generateDetailedReport(filteredTransactions);
                        break;
                    case 'cashflow':
                        summaryHTML = this.generateCashFlowReport(filteredTransactions);
                        break;
                    case 'comparison':
                        summaryHTML = this.generateComparisonReport(filteredTransactions);
                        break;
                }
                
                reportSummary.innerHTML = summaryHTML;
                reportResults.style.display = 'block';
            }

            generateSummaryReport(transactions) {
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const balance = totalIncome - totalExpenses;
                const transactionCount = transactions.length;

                return `
                    <div class="summary-item">
                        <div class="summary-label">Total de Transações</div>
                        <div class="summary-value">${transactionCount}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total de Receitas</div>
                        <div class="summary-value income-value">${this.formatCurrency(totalIncome)}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total de Despesas</div>
                        <div class="summary-value expense-value">${this.formatCurrency(totalExpenses)}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Saldo Final</div>
                        <div class="summary-value ${balance >= 0 ? 'income-value' : 'expense-value'}">${this.formatCurrency(balance)}</div>
                    </div>
                `;
            }

            generateDetailedReport(transactions) {
                const categoryTotals = {};
                
                transactions.forEach(transaction => {
                    const category = this.getCategoryById(transaction.categoryId);
                    const categoryName = category ? category.name : 'Categoria não encontrada';
                    
                    if (!categoryTotals[categoryName]) {
                        categoryTotals[categoryName] = { income: 0, expense: 0 };
                    }
                    
                    if (transaction.type === 'income') {
                        categoryTotals[categoryName].income += transaction.amount;
                    } else {
                        categoryTotals[categoryName].expense += transaction.amount;
                    }
                });

                let html = '<h5 style="margin-bottom: 15px; color: #2c3e50;">Detalhamento por Categoria:</h5>';
                Object.entries(categoryTotals).forEach(([category, totals]) => {
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <strong>${category}</strong><br>
                            <span style="color: #27ae60;">Receitas: ${this.formatCurrency(totals.income)}</span><br>
                            <span style="color: #e74c3c;">Despesas: ${this.formatCurrency(totals.expense)}</span><br>
                            <span style="font-weight: bold;">Saldo: ${this.formatCurrency(totals.income - totals.expense)}</span>
                        </div>
                    `;
                });
                
                return html;
            }

            generateCashFlowReport(transactions) {
                const sortedTransactions = transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                let runningBalance = 0;
                
                let html = '<h5 style="margin-bottom: 15px; color: #2c3e50;">Fluxo de Caixa Diário:</h5>';
                html += '<div style="overflow-x: auto; margin-top: 15px;">';
                html += '<table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">';
                html += '<thead style="background: #3498db; color: white;">';
                html += '<tr style="text-align: left;">';
                html += '<th style="padding: 12px; font-weight: 600;">Data</th>';
                html += '<th style="padding: 12px; font-weight: 600;">Receita</th>';
                html += '<th style="padding: 12px; font-weight: 600;">Despesa</th>';
                html += '<th style="padding: 12px; font-weight: 600;">Saldo</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';
                
                const dailyTotals = {};
                sortedTransactions.forEach(transaction => {
                    const date = transaction.date;
                    if (!dailyTotals[date]) {
                        dailyTotals[date] = { income: 0, expense: 0 };
                    }
                    
                    if (transaction.type === 'income') {
                        dailyTotals[date].income += transaction.amount;
                    } else {
                        dailyTotals[date].expense += transaction.amount;
                    }
                });

                Object.entries(dailyTotals).forEach(([date, totals], index) => {
                    runningBalance += (totals.income - totals.expense);
                    const rowStyle = index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;';
                    
                    html += `<tr style="${rowStyle} border-bottom: 1px solid #ecf0f1;">`;
                    html += `<td style="padding: 12px; font-weight: 500;">${this.formatDate(date)}</td>`;
                    html += `<td style="padding: 12px; color: #27ae60; font-weight: 600;">${this.formatCurrency(totals.income)}</td>`;
                    html += `<td style="padding: 12px; color: #e74c3c; font-weight: 600;">${this.formatCurrency(totals.expense)}</td>`;
                    html += `<td style="padding: 12px; font-weight: 700; ${runningBalance >= 0 ? 'color: #27ae60;' : 'color: #e74c3c;'}">${this.formatCurrency(runningBalance)}</td>`;
                    html += '</tr>';
                });
                
                // RESUMO NO RODAPÉ DA TABELA
                const totalIncome = Object.values(dailyTotals).reduce((sum, day) => sum + day.income, 0);
                const totalExpense = Object.values(dailyTotals).reduce((sum, day) => sum + day.expense, 0);
                const finalBalance = totalIncome - totalExpense;
                
                html += '<tfoot style="background: #ecf0f1; font-weight: bold;">';
                html += '<tr style="border-top: 2px solid #3498db;">';
                html += '<td style="padding: 12px; font-weight: 700;">TOTAL</td>';
                html += `<td style="padding: 12px; color: #27ae60; font-size: 1.1em;">${this.formatCurrency(totalIncome)}</td>`;
                html += `<td style="padding: 12px; color: #e74c3c; font-size: 1.1em;">${this.formatCurrency(totalExpense)}</td>`;
                html += `<td style="padding: 12px; font-size: 1.1em; ${finalBalance >= 0 ? 'color: #27ae60;' : 'color: #e74c3c;'}">${this.formatCurrency(finalBalance)}</td>`;
                html += '</tr>';
                html += '</tfoot>';
                
                html += '</tbody>';
                html += '</table>';
                html += '</div>';
                
                return html;
            }

            generateComparisonReport(transactions) {
                const monthlyData = {};
                
                transactions.forEach(transaction => {
                    const date = new Date(transaction.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { income: 0, expense: 0 };
                    }
                    
                    if (transaction.type === 'income') {
                        monthlyData[monthKey].income += transaction.amount;
                    } else {
                        monthlyData[monthKey].expense += transaction.amount;
                    }
                });

                let html = '<h5 style="margin-bottom: 15px; color: #2c3e50;">Comparativo Mensal:</h5>';
                Object.entries(monthlyData)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .forEach(([month, totals]) => {
                        const [year, monthNum] = month.split('-');
                        const monthName = new Date(year, monthNum - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                        
                        html += `
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                <strong>${monthName}</strong><br>
                                <span style="color: #27ae60;">Receitas: ${this.formatCurrency(totals.income)}</span><br>
                                <span style="color: #e74c3c;">Despesas: ${this.formatCurrency(totals.expense)}</span><br>
                                <span style="font-weight: bold;">Saldo: ${this.formatCurrency(totals.income - totals.expense)}</span>
                            </div>
                        `;
                    });
                
                return html;
            }

            // ==== Funções para exportação de relatórios PDF e Excel ====


            exportToPDF(transactions, reportType, startDate, endDate) {
                try {
                    if (typeof window.jspdf === 'undefined') {
                        this.showToast('Biblioteca jsPDF não carregada', 'error');
                        return;
                    }
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    if (!transactions || transactions.length === 0) {
                        this.showToast('Nenhuma transação para exportar', 'warning');
                        return;
                    }
                    
                    // Configurações seguras
                    const margin = 20;
                    let yPos = 30;
                    const pageHeight = doc.internal.pageSize.height;
                    
                    // Cabeçalho com verificações
                    try {
                        doc.setFontSize(18);
                        doc.setTextColor(44, 62, 80);
                        const titulo = 'Relatório Financeiro - Igreja';
                        doc.text(titulo, 105, yPos, { align: 'center' });
                        
                        yPos += 15;
                        doc.setFontSize(11);
                        doc.setTextColor(127, 140, 141);
                        const periodo = startDate && endDate 
                            ? `Período: ${this.formatDate(startDate)} a ${this.formatDate(endDate)}`
                            : 'Período: Todas as transações';
                        doc.text(periodo, 105, yPos, { align: 'center' });
                        
                        yPos += 12;
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        const tipoRel = this.getReportTypeName(reportType);
                        doc.text(`Tipo: ${tipoRel}`, margin, yPos);
                        
                    } catch (err) {
                        console.warn('Erro ao gerar cabeçalho:', err);
                    }
                    
                    yPos += 20;
                    
                    // Dados das transações - MÉTODO SIMPLIFICADO
                    const sortedTrans = transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                    let totalRec = 0, totalDes = 0;
                    
                    // Cabeçalho da tabela simplificado
                    try {
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        
                        // Textos com verificação
                        const headers = ['Data', 'Descrição', 'Cat.', 'Receita', 'Despesa'];
                        const positions = [margin, margin+20, margin+65, margin+95, margin+125];
                        
                        headers.forEach((header, i) => {
                            if (positions[i] && typeof positions[i] === 'number') {
                                doc.text(header, positions[i], yPos);
                            }
                        });
                        
                        yPos += 8;
                        doc.setFont(undefined, 'normal');
                        
                    } catch (err) {
                        console.warn('Erro ao gerar cabeçalho da tabela:', err);
                    }
                    
                    // Processar cada transação com try-catch individual
                    sortedTrans.forEach((trans, idx) => {
                        try {
                            // Verificar espaço na página
                            if (yPos > 270) {
                                doc.addPage();
                                yPos = 25;
                            }
                            
                            const cat = this.getCategoryById(trans.categoryId);
                            const catNome = cat ? cat.name : 'Sem Cat.';
                            const desc = trans.description.length > 20 ? trans.description.substring(0, 20) + '...' : trans.description;
                            
                            // Dados básicos com conversão segura
                            const dataText = this.formatDate(trans.date);
                            const descText = desc;
                            const catText = catNome.length > 10 ? catNome.substring(0, 10) + '...' : catNome;
                            
                            // Escrever textos com verificação
                            if (dataText && typeof dataText === 'string') {
                                doc.text(dataText, margin, yPos);
                            }
                            if (descText && typeof descText === 'string') {
                                doc.text(descText, margin + 20, yPos);
                            }
                            if (catText && typeof catText === 'string') {
                                doc.text(catText, margin + 65, yPos);
                            }
                            
                            // Valores com cores
                            if (trans.type === 'income') {
                                doc.setTextColor(39, 174, 96);
                                const valorText = this.formatCurrency(trans.amount);
                                if (valorText && typeof valorText === 'string') {
                                    doc.text(valorText, margin + 95, yPos, { align: 'left' });
                                }
                                totalRec += trans.amount;
                            } else {
                                doc.setTextColor(231, 76, 60);
                                const valorText = this.formatCurrency(trans.amount);
                                if (valorText && typeof valorText === 'string') {
                                    doc.text(valorText, margin + 125, yPos, { align: 'left' });
                                }
                                totalDes += trans.amount;
                            }
                            
                            doc.setTextColor(0, 0, 0);
                            yPos += 6;
                            
                        } catch (err) {
                            console.warn(`Erro ao processar transação ${idx}:`, err);
                            yPos += 6; // Continuar mesmo com erro
                        }
                    });
                    
                    // Resumo final com proteção
                    try {
                        yPos += 15;
                        doc.setFontSize(12);
                        doc.setTextColor(44, 62, 80);
                        doc.setFont(undefined, 'bold');
                        doc.text('Resumo Financeiro', margin, yPos);
                        
                        yPos += 10;
                        doc.setFontSize(10);
                        
                        const resumo = [
                            ['Total Receitas:', this.formatCurrency(totalRec)],
                            ['Total Despesas:', this.formatCurrency(totalDes)],
                            ['Saldo Final:', this.formatCurrency(totalRec - totalDes)]
                        ];
                        
                        resumo.forEach((linha, i) => {
                            if (yPos > 270) {
                                doc.addPage();
                                yPos = 25;
                            }
                            doc.setFont(undefined, 'bold');
                            doc.text(linha[0], margin + 10, yPos);
                            doc.setFont(undefined, 'normal');
                            
                            // Cor para saldo final
                            if (i === 2) {
                                const saldo = totalRec - totalDes;
                                doc.setTextColor(saldo >= 0 ? [39, 174, 96] : [231, 76, 60]);
                            }
                            
                            if (linha[1] && typeof linha[1] === 'string') {
                                doc.text(linha[1], margin + 60, yPos);
                            }
                            doc.setTextColor(0, 0, 0);
                            yPos += 8;
                        });
                        
                    } catch (err) {
                        console.warn('Erro ao gerar resumo:', err);
                    }
                    
                    // Rodapé
                    try {
                        const pages = doc.internal.getNumberOfPages();
                        for (let i = 1; i <= pages; i++) {
                            doc.setPage(i);
                            doc.setFontSize(8);
                            doc.setTextColor(127, 140, 141);
                            const footerText = `Gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')} | Página ${i} de ${pages}`;
                            doc.text(footerText, 105, 290, { align: 'center' });
                        }
                    } catch (err) {
                        console.warn('Erro ao gerar rodapé:', err);
                    }
                    
                    // Salvar arquivo
                    const nomeArquivo = `Relatorio_Igreja_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(nomeArquivo);
                    
                    this.showToast('PDF exportado com sucesso!', 'success');
                    
                } catch (error) {
                    console.error('Erro fatal ao exportar PDF:', error);
                    this.showToast('Erro ao gerar PDF. Verifique os dados e tente novamente.', 'error');
                }
            }


            exportToExcel(transactions, reportType, startDate, endDate) {
                try {
                    // Preparar dados para o Excel
                    const excelData = [];
                    let totalIncome = 0;
                    let totalExpense = 0;
                    
                    // Cabeçalhos
                    excelData.push(['Relatório Financeiro - Igreja']);
                    excelData.push([`Período: ${startDate && endDate ? this.formatDate(startDate) + ' a ' + this.formatDate(endDate) : 'Todas as transações'}`]);
                    excelData.push([`Tipo: ${this.getReportTypeName(reportType)}`]);
                    excelData.push([]); // Linha vazia
                    excelData.push(['Data', 'Descrição', 'Categoria', 'Tipo', 'Valor', 'Saldo Acumulado']);
                    
                    // Dados das transações
                    let accumulatedBalance = 0;
                    const sortedTransactions = transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    sortedTransactions.forEach(transaction => {
                        const category = this.getCategoryById(transaction.categoryId);
                        const categoryName = category ? category.name : 'Sem Categoria';
                            
                        if (transaction.type === 'income') {
                            accumulatedBalance += transaction.amount;
                            totalIncome += transaction.amount;
                        } else {
                            accumulatedBalance -= transaction.amount;
                            totalExpense += transaction.amount;
                        }
                        
                        excelData.push([
                            this.formatDate(transaction.date),
                            transaction.description,
                            categoryName,
                            transaction.type === 'income' ? 'Receita' : 'Despesa',
                            transaction.amount,
                            accumulatedBalance
                        ]);
                    });
                        
                    // Adicionar totais
                    excelData.push([]); // Linha vazia
                    excelData.push(['TOTAIS', '', '', '', '', '']);
                    excelData.push(['Total Receitas:', '', '', '', totalIncome, '']);
                    excelData.push(['Total Despesas:', '', '', '', totalExpense, '']);
                    excelData.push(['Saldo Final:', '', '', '', (totalIncome - totalExpense), '']);
                    
                    // Criar workbook e worksheet
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(excelData);
                    
                    // Estilizar o worksheet
                    ws['!cols'] = [
                        { wch: 12 }, // Data
                        { wch: 40 }, // Descrição
                        { wch: 25 }, // Categoria
                        { wch: 10 }, // Tipo
                        { wch: 15 }, // Valor
                        { wch: 15 }  // Saldo
                    ];
                        
                    // Aplicar estilos (cores e negrito)
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for (let row = range.s.r; row <= range.e.r; row++) {
                        for (let col = range.s.c; col <= range.e.c; col++) {
                            const cell = ws[XLSX.utils.encode_cell({ r: row, c: col })];
                            if (!cell) continue;
                            
                            // Cabeçalho principal
                            if (row <= 2) {
                                cell.s = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "3498DB" } } };
                            }
                            
                            // Cabeçalho da tabela
                            if (row === 4) {
                                cell.s = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "2C3E50" } }, alignment: { horizontal: "center" } };
                            }
                            
                            // Coluna de valores
                            if (col === 4 && row > 4 && row < range.e.r - 3) {
                                cell.s = { alignment: { horizontal: "right" }, numFmt: '"R$"#,##0.00' };
                            }
                            
                            // Coluna de saldo
                            if (col === 5 && row > 4 && row < range.e.r - 3) {
                                cell.s = { alignment: { horizontal: "right" }, numFmt: '"R$"#,##0.00' };
                            }
                            
                            // Linhas de total
                            if (row >= range.e.r - 2) {
                                cell.s = { font: { bold: true }, fill: { fgColor: { rgb: "ECF0F1" } } };
                            }
                        }
                    }
                        
                    // Adicionar worksheet ao workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Relatório Financeiro');
                    
                    // Salvar arquivo
                    const fileName = `Relatorio_Financeiro_Igreja_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                        this.showToast('Excel exportado com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao exportar Excel:', error);
                        this.showToast('Erro ao exportar Excel. Tente novamente.', 'error');
                    }
                }

            // Função auxiliar para obter nome do tipo de relatório
            getReportTypeName(reportType) {
                const types = {
                    'summary': 'Resumo Financeiro',
                    'detailed': 'Detalhado por Categoria',
                    'cashflow': 'Fluxo de Caixa',
                    'comparison': 'Comparativo Mensal'
                };
                return types[reportType] || 'Relatório Geral';
            }
                                


            formatCurrency(amount) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(amount);
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('pt-BR');
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
                    ${message}
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 3000);
            }

            saveData() {
                localStorage.setItem('churchTransactions', JSON.stringify(this.transactions));
                localStorage.setItem('churchCategories', JSON.stringify(this.categories));
            }

            loadSavedLogo() {
                const savedLogo = localStorage.getItem('churchLogo');
                if (savedLogo) {
                    this.displayLogo(savedLogo);
                }
            }

            displayLogo(imageData) {
                const logoImg = document.getElementById('churchLogo');
                const logoPlaceholder = document.getElementById('logoPlaceholder');
                
                if (logoImg && logoPlaceholder) {
                    logoImg.src = imageData;
                    logoImg.style.display = 'block';
                    logoPlaceholder.style.display = 'none';
                }
            }

            displayPlaceholder() {
                const logoImg = document.getElementById('churchLogo');
                const logoPlaceholder = document.getElementById('logoPlaceholder');
                
                if (logoImg && logoPlaceholder) {
                    logoImg.style.display = 'none';
                    logoPlaceholder.style.display = 'flex';
                }
            }

            openCategoryModal(type = 'income') {
                const categoryModal = document.getElementById('categoryModal');
                const categoryType = document.getElementById('categoryType');
                const categoryModalTitle = document.getElementById('categoryModalTitle');

                if (categoryModal && categoryType && categoryModalTitle) {
                    categoryType.value = type;
                    categoryModal.style.display = 'block';
                    
                    // Limpar formulário se não estiver editando
                    if (!this.currentEditingCategory) {
                        categoryModalTitle.textContent = 'Adicionar Categoria';
                        const categoryForm = document.getElementById('categoryForm');
                        if (categoryForm) categoryForm.reset();
                    } else {
                        categoryModalTitle.textContent = 'Editar Categoria';
                    }
                }
            }

            closeCategoryModal() {
                const categoryModal = document.getElementById('categoryModal');
                if (categoryModal) {
                    categoryModal.style.display = 'none';
                    
                    // IMPORTANTE: Limpar estado de edição ao fechar
                    this.currentEditingCategory = null;
                    
                    // Limpar formulário
                    const categoryForm = document.getElementById('categoryForm');
                    if (categoryForm) categoryForm.reset();
                    
                    // Resetar título
                    const categoryModalTitle = document.getElementById('categoryModalTitle');
                    if (categoryModalTitle) categoryModalTitle.textContent = 'Adicionar Categoria';
                }
            }

            openEditTransactionModal() {
                const editModal = document.getElementById('editTransactionModal');
                if (editModal) {
                    editModal.style.display = 'block';
                }
            }

            closeEditTransactionModal() {
                const editModal = document.getElementById('editTransactionModal');
                if (editModal) {
                    editModal.style.display = 'none';
                    this.currentEditingTransaction = null;
                }
            }
        }

        // CORREÇÃO: Inicializar churchSystem após a definição da classe
        churchSystem = new ChurchFinancialSystem();

        // Funções globais
        function changeLogo() {
            const logoInput = document.getElementById('logoInput');
            if (logoInput) logoInput.click();
        }

        function handleLogoChange(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    localStorage.setItem('churchLogo', imageData);
                    if (churchSystem) {
                        churchSystem.displayLogo(imageData);
                        churchSystem.showToast('Logo atualizada com sucesso!', 'success');
                    }
                };
                reader.readAsDataURL(file);
            } else {
                if (churchSystem) {
                    churchSystem.showToast('Por favor, selecione uma imagem válida!', 'error');
                }
            }
        }

        function openCategoryModal(type = 'income') {
            if (churchSystem) {
                churchSystem.openCategoryModal(type);
            }
        }

        function closeCategoryModal() {
            if (churchSystem) {
                churchSystem.closeCategoryModal();
            }
        }

        function openEditTransactionModal() {
            if (churchSystem) {
                churchSystem.openEditTransactionModal();
            }
        }

        function closeEditTransactionModal() {
            if (churchSystem) {
                churchSystem.closeEditTransactionModal();
            }
        }

        function generateReport() {
            if (churchSystem) {
                churchSystem.generateReport();
            }
        }

        // Fechar modais ao clicar fora
        window.onclick = function(event) {
            const categoryModal = document.getElementById('categoryModal');
            const editModal = document.getElementById('editTransactionModal');
            
            if (event.target === categoryModal) {
                closeCategoryModal();
            }
            if (event.target === editModal) {
                closeEditTransactionModal();
            }
        }

        function exportToPDF() {
            if (churchSystem) {
                const reportType = document.getElementById('reportType').value;
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                
                let filteredTransactions = churchSystem.transactions;
                if (startDate && endDate) {
                    filteredTransactions = churchSystem.transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        const end = new Date(endDate);
                        end.setDate(end.getDate() + 1);
                        return transactionDate >= new Date(startDate) && transactionDate < end;
                    });
                }
                
                churchSystem.exportToPDF(filteredTransactions, reportType, startDate, endDate);
            }
        }

        function exportToExcel() {
            if (churchSystem) {
                const reportType = document.getElementById('reportType').value;
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                
                let filteredTransactions = churchSystem.transactions;
                if (startDate && endDate) {
                    filteredTransactions = churchSystem.transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        const end = new Date(endDate);
                        end.setDate(end.getDate() + 1);
                        return transactionDate >= new Date(startDate) && transactionDate < end;
                    });
                }
                
                churchSystem.exportToExcel(filteredTransactions, reportType, startDate, endDate);
            }
        }


        // CORREÇÃO: Garantir inicialização completa após carregamento do DOM
        document.addEventListener('DOMContentLoaded', function() {
            if (churchSystem) {
                churchSystem.setupEventListeners();
                churchSystem.setupFormHandlers();
                churchSystem.setDefaultDates();
            }
        });
    </script>
</body>
</html>